#------------------------------------------------------------------------------
# @file Makefile
# @author charlesj
# @date 2014-05-14 17:07:05.115117
# @brief Makefile for mixed language (Fortran90, CUDA) compilation
# 
# Makefile for mixed language (Fortran90, CUDA) compilation
# 
# This file was generated by Kppa: http://www.paratools.com/Kppa
#------------------------------------------------------------------------------


FC=ftn
#FC = mpif90
#FC = gfortran
NVCC = nvcc
LD = $(FC)

CUDA_HOME = /opt/cray/nvidia/default/

ARCH_FLAGS = -arch sm_35 --use_fast_math
OPT_FLAGS = -O3
WARN_FLAGS = -Wall
PREC_FLAGS = -fdefault-real-8 -fdefault-double-8 -fbounds-check -fimplicit-none

# Uncomment this line to get more information about your CUDA device
#CUDA_CPPFLAGS = -DSHOW_CUDA_DEVICE_PROPERTIES=1

CPPFLAGS = $(CUDA_CPPFLAGS)
FFLAGS = $(OPT_FLAGS) $(WARN_FLAGS) $(PREC_FLAGS)
CXXFLAGS = $(OPT_FLAGS) $(ARCH_FLAGS)
LDFLAGS = $(OPT_FLAGS) -L$(CUDA_HOME)/lib64 -L$(CUDA_HOME)/lib
LIBS = -lm -lcudart

OBJ = box_model_integrate.o \
      box_model_jacobian.o \
      box_model_main.o \
      box_model_parameters.o \
      box_model_cu_integrate.o \
      box_model_rosenbrock.o \
      box_model_blas.o \
      box_model_rates.o \
      box_model_function.o \
      box_model_decomp.o \
      box_model_solve.o \
      box_model_initialize.o \
      box_model_driver_parameters.o \
      box_model_monitor.o


EXE = box_model.exe

all: $(EXE)

$(EXE):  $(OBJ)
	$(LD) -o $(EXE) $(LDFLAGS) $(OBJ) $(LIBS)



box_model_integrate.o: box_model_integrate.f90 \
        box_model_parameters.mod \
        box_model_cu_integrate.o \
        box_model_rosenbrock.o
	$(FC) -c $(FFLAGS) -o box_model_integrate.o box_model_integrate.f90

box_model_jacobian.o: box_model_jacobian.cu \
        box_model_cu_parameters.h \
        box_model_sparse.h
	$(NVCC) -c $(CXXFLAGS) $(CPPFLAGS) -o box_model_jacobian.o box_model_jacobian.cu

box_model_main.o: box_model_main.f90 \
        box_model_parameters.mod \
        box_model_integrate.o \
        box_model_initialize.o \
        box_model_driver_parameters.mod \
        box_model_monitor.o
	$(FC) -I$(MPICH_DIR)/include -c $(FFLAGS) -o box_model_main.o box_model_main.f90

box_model_parameters.mod: box_model_parameters.f90
	$(FC) -c $(FFLAGS) -o box_model_parameters.o box_model_parameters.f90

box_model_cu_integrate.o: box_model_cu_integrate.cu \
        box_model_cu_parameters.h \
        box_model_sparse.h
	$(NVCC) -c $(CXXFLAGS) $(CPPFLAGS) -o box_model_cu_integrate.o box_model_cu_integrate.cu

box_model_rosenbrock.o: box_model_rosenbrock.cu \
        box_model_cu_parameters.h \
        box_model_blas.o \
        box_model_rates.o \
        box_model_function.o \
        box_model_decomp.o \
        box_model_solve.o \
        box_model_jacobian.o \
        box_model_sparse.h
	$(NVCC) -c $(CXXFLAGS) $(CPPFLAGS) -o box_model_rosenbrock.o box_model_rosenbrock.cu

box_model_blas.o: box_model_blas.cu \
        box_model_cu_parameters.h
	$(NVCC) -c $(CXXFLAGS) $(CPPFLAGS) -o box_model_blas.o box_model_blas.cu

box_model_rates.o: box_model_rates.cu \
        box_model_cu_parameters.h
	$(NVCC) -c $(CXXFLAGS) $(CPPFLAGS) -o box_model_rates.o box_model_rates.cu

box_model_function.o: box_model_function.cu \
        box_model_cu_parameters.h \
        box_model_sparse.h
	$(NVCC) -c $(CXXFLAGS) $(CPPFLAGS) -o box_model_function.o box_model_function.cu

box_model_decomp.o: box_model_decomp.cu \
        box_model_cu_parameters.h \
        box_model_sparse.h
	$(NVCC) -c $(CXXFLAGS) $(CPPFLAGS) -o box_model_decomp.o box_model_decomp.cu

box_model_solve.o: box_model_solve.cu \
        box_model_cu_parameters.h \
        box_model_sparse.h
	$(NVCC) -c $(CXXFLAGS) $(CPPFLAGS) -o box_model_solve.o box_model_solve.cu

box_model_initialize.o: box_model_initialize.f90 \
        box_model_parameters.mod
	$(FC) -c $(FFLAGS) -o box_model_initialize.o box_model_initialize.f90

box_model_driver_parameters.mod: box_model_driver_parameters.f90
	$(FC) -c $(FFLAGS) -o box_model_driver_parameters.o box_model_driver_parameters.f90

box_model_monitor.o: box_model_monitor.f90 \
        box_model_parameters.mod
	$(FC) -c $(FFLAGS) -o box_model_monitor.o box_model_monitor.f90


clean:
	rm -f box_model.exe box_model.dat boxmodel.* *.o *.mod

destroy: clean
	rm -f *.f90 *.cu *.h Makefile *general *performance

#----------------------------- END Makefile END -------------------------------
