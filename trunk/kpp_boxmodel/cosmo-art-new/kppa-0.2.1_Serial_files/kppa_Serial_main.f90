!---------------------- BEGIN kppa_Serial_main.f90 BEGIN ---------------------
! @file kppa_Serial_main.f90                                                  
! @author charlesj                                                            
! @date 2015-02-10 15:56:51.197762                                            
! @brief Fortran90 driver with plplot                                         
!                                                                             
! Fortran90 driver with plplot                                                
!                                                                             
! This file was generated by Kppa: http://www.paratools.com/Kppa              
!-----------------------------------------------------------------------------



PROGRAM main

    USE kppa_Serial_parameters
    USE kppa_Serial_integrate
    USE kppa_Serial_initialize
    USE kppa_Serial_driver_parameters
    USE kppa_Serial_monitor

    IMPLICIT NONE

    !---------------------------------------------------------------------------
    ! Program data                                                               
    !---------------------------------------------------------------------------

  ! Integration status code 
  INTEGER :: retval
  ! Absolute integration tolerances for variable species 
  REAL(8) :: abstol(83)
  ! Relative integration tolerances for variable species 
  REAL(8) :: reltol(83)

  ! Integer integration in/out parameters 
  INTEGER :: idata(20)
  ! Real value integration in/out parameters 
  REAL(8) :: rdata(20)

    ! Species concentrations for all grid cells
    REAL(8), ALLOCATABLE :: conc(:,:)

    ! Last stepsize in each grid cell
    REAL(8), ALLOCATABLE :: lastH(:)
    
    ! Iterator
    INTEGER :: i
    
    !---------------------------------------------------------------------------
    ! Program text                                                               
    !---------------------------------------------------------------------------

    WRITE(*,101) NCELLS,TSTART,TEND
101 FORMAT("Kppa: Integrating ",I8," grid cells, time interval [",E8.2,",",E8.2,"]")

    ! Initialize example grid data
    ALLOCATE(conc(NSPEC,NCELLS))
    DO i=1,ncells
        CALL Initialize(conc(1:NVAR,i), conc(NVAR+1:NSPEC,i))
    END DO
    
    ! Allocate storage for last step size (useful in reentrant solvers)
    ALLOCATE(lastH(ncells))

    ! Initialize vector tolerances
    abstol = ATOLS
    reltol = RTOLS

    ! Initialize integration parameters to 0 = use defaults
    idata = 0
    rdata = 0

    ! Rosenbrock default parameters
    idata(1) = 0       ! System is non-autonomous: F = F(t,y)
    idata(2) = 0       ! Use vector tolerances
    idata(3) = 100000  ! Maximum number of integration steps
    idata(4) = 5       ! Rodas4 Rosenbrock method
    idata(5) = 0       ! Tolerance vectors will not be checked

    rdata(1) = 0       ! Integration step size lower bound: 0 recommended
    rdata(2) = 0       ! Integration step size upper bound: 0 recommended
    rdata(3) = TDEL    ! Starting integration step size
    rdata(4) = 0.2     ! Lower bound on step decrease factor
    rdata(5) = 6       ! Upper bound on step increase factor
    rdata(6) = 0.1     ! Step decrease factor after step rejection
    rdata(7) = 0.9     ! Safety factor in the computation of new step size

    retval = GridIntegrate(NCELLS, conc, TSTART, TEND, &
                           abstol, reltol, idata, rdata, lastH) 

    ! Report status
    IF (retval < 0) THEN
        WRITE(*,102) "FAILED"
    ELSE IF (retval > 0) THEN
        WRITE(*,102) "SUCCEEDED WITH WARNINGS"
    ELSE
        WRITE(*,102) "SUCCEEDED"
    END IF
102 FORMAT("Kppa: GRID INTEGRATION ",A)
    WRITE(*,103) idata(13),idata(14),idata(15),idata(18), &
                 idata(11),idata(12),idata(16),idata(17)
103 FORMAT("Kppa: Stp=",I12,", Acc=",I12,", Rej=",I12,", Sng=",I12, &
               ", Fun=",I12,", Jac=",I12,", Dec=",I12,", Sol=",I12)

    ! Clean up and exit
    DEALLOCATE(conc)
    DEALLOCATE(lastH)
    CALL EXIT(retval)
    STOP


END PROGRAM main


!------------------------ END kppa_Serial_main.f90 END -----------------------
