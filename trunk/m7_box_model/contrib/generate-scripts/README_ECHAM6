##################################################################################
#
# This is a simple recipe to checkout and run the ECHAM6 model
# Model components are
#      ECHAM  - global atmosphere GCM (MPI-M)
#      JSBACH - global land surface model (MPI-M)
#
# - only restarts are possible
# - only yearly chunks
# - only for resolutions LR (T63L47) or MR (T63L95)
#
# - only predefined experiment settings (cmip5-style) possible:
#   - LR: amip, sstClim
#   - MR: amip, sstClim
#
# RERUN-files are taken from the original CMIP5 experiments (1st realization)
# 
# Monika Esch, MPI, 2012-02-23
# 
##################################################################################

1. Login and untar (or checkout) the model
------------------------------------------

Login on blizzard.dkrz.de

untar the echam-6.1.00-tarfile you got

or checkout the latest tag, e.g.:
svn checkout http://svn.zmaw.de/svn/echam6/tags/echam-6.1.00

on your HOME(!)-directory, e.g. "/home/zmaw/m214002"

This results in a directory named echam-6.1.00.
##################################################################################

2. Compiling
------------

To compile the model change the directory:

cd echam-6.1.00

First load the right module for the compiler:

module load IBM/xlf13.1.0.2

configure the Makefile:

./configure --with-openmp

and compile the model:

make -j 4

The model executable will be generated and stored in the 'bin'-directory.
This might take a while.
The model executable's name is simply echam6.

The "-j 4"-add-on takes care that the compilation is done on 4 cpus in parallel.

When you change the executable name you have to edit the generate-echam.sh 
(ECHAM_EXE) accordingly.

Be careful: if you do not compile with the openMP option your executable
doesn't fit to the given scripts! Then check the setting of tasks_per_node,
task_affinity, parallel_threads and ECHAM6_THREADS!
##################################################################################

3. Building the scripts and running the model
---------------------------------------------

cd contrib/generate-scripts

Edit the shell script generate-echam.sh following the examples given in the script 
and simply run

./generate-echam.sh

The generate-echam.sh-script finally tells you where to find your run- and
postprocessing script, e.g.
"you will find your scripts in
/home/zmaw/m214002/echam-6.1.00/experiments/mbe0316/scripts"

In this directory your scripts are stored and the job-output of your
running jobs.

cd /home/zmaw/<USER>/echam-6.1.00/experiments/<EXP_ID>/scripts
llsubmit <EXP_ID>.run

To check the status of your job type

llq -u <USER>

Detailed information is given by 

llq -W -f %id %o %jn %jt %a %gl %dq %c %nh %st %h -u <USER>
##################################################################################

4. General Remarks
------------------

As first test you should run a one year simulation and compare your output
with the original data produced by the according CMIP5 experiment.
(see: https://cmip5-cordex.dkrz.de/CMIP5/).
In case of differences please check that you loaded the right compiler 
version before compiling!

After one year is finally processed you will find the models output (the raw 
data) in your data-directory,
/work/<GROUP_ID>/<USER_ID>/<REPOS_NAM>/experiments/<EXP_ID>/,
as defined in generate-echam.sh. All output data are stored in this directory!

At the end of one year of simulation the <EXP_ID>.run is submitted again unless
the final_date is reached. In addition the job2/subjob2 is submitted to do
a first post processing of the model data. The postprocessed data will be stored
in a subdirectory of the data-directory:
/work/<GROUP_ID>/<USER_ID>/<REPOS_NAM>/experiments/<EXP_ID>/post.

For follow-up experiments you can either generate more runscripts using the
generate-echam.sh-script, or simply copy the <EXP_ID>.run, job1 and job2 to a 
new ~/<REPOS_NAM>/experiments/<EXP_ID>/scripts directory and edit them directly.
You don't have to compile the model again and again but can use the same
executable for a variety of experiments.
##################################################################################

5. Further Hints
----------------

Changing the namelists after generating the scripts:

The run scripts generated by ./generate-echam.sh copy the Fortran namelists,
which define the experiment, from read only directories on Blizzard at:

   /pool/data/ECHAM6/cmip5_namelists/${expname}

in order to obtain a model configuration, which can reproduce tested
experiments, or here CMIP5 experiments.

Thus, if an experiment should be modified by namelist changes, it must be avoided 
that the run script automatically gets the original namelists. You may proceed as
follows: 

1)  copy namelist.echam of the experiment of interest (${expname}) from 
      /pool/data/ECHAM6/cmip5_namelists/${expname} to your own scripts-directory
2)  modify the namelist as you want
3)  change the line in your run script from:
      cp /pool/data/ECHAM6/cmip5_namelists/${expname}/namelist.echam .
    to:
      cp $home/${expid}/scripts/namelist.echam . 
    so that this namelist will be copied into the run script.

##################################################################################


* 
the <EXP_ID> by convention consists of 3 letters and 4 digits, where the 3
letters are an abbreviation that should result from the experimenter's name.
People inside MPI-M are asked to fill in their abbreviations for the naming 
convention in
http://svn.zmaw.de/dokuwiki/doku.php?id=listofids:list_of_experimenter_ids

##################################################################################
Please send comments etc. to monika.esch@zmaw.de
